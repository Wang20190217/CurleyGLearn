# OAuth 2.0ï¼ˆSSO å•ç‚¹ç™»å½•)

æœ¬å±Šå†…å®¹å¯ä»¥è§‚çœ‹å¦‚ä¸‹è§†é¢‘ï¼š

- [02ã€åŸºäºæˆæƒç æ¨¡å¼ï¼Œå¦‚ä½•å®ç° SSO å•ç‚¹ç™»å½•ï¼Ÿ](https://t.zsxq.com/06fUne6yZ)
- [03ã€è¯·æ±‚æ—¶ï¼Œå¦‚ä½•æ ¡éªŒ accessToken è®¿é—®ä»¤ç‰Œï¼Ÿ](https://t.zsxq.com/06iuNRvjM)
- [04ã€è®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶ï¼Œå¦‚ä½•åˆ·æ–° Token ä»¤ç‰Œï¼Ÿ](https://t.zsxq.com/06jAqFimu)
- [05ã€ç™»å½•æˆåŠŸåï¼Œå¦‚ä½•è·å¾—ç”¨æˆ·ä¿¡æ¯ï¼Ÿ](https://t.zsxq.com/06ne6e6aE)
- [06ã€é€€å‡ºæ—¶ï¼Œå¦‚ä½•åˆ é™¤ Token ä»¤ç‰Œï¼Ÿ](https://t.zsxq.com/06fUJIUfq)
- [07ã€åŸºäºå¯†ç æ¨¡å¼ï¼Œå¦‚ä½•å®ç° SSO å•ç‚¹ç™»å½•ï¼Ÿ](https://t.zsxq.com/06rrrzBAu)

- [08ã€å¦‚ä½•å®ç°å®¢æˆ·ç«¯çš„ç®¡ç†ï¼Ÿ](https://t.zsxq.com/06ubEmeII)
- [09ã€å•ç‚¹ç™»å½•ç•Œé¢ï¼Œå¦‚ä½•è¿›è¡Œåˆå§‹åŒ–ï¼Ÿ](https://t.zsxq.com/06qjm2rbQ)
- [10ã€å•ç‚¹ç™»å½•ç•Œé¢ï¼Œå¦‚ä½•è¿›è¡Œã€æ‰‹åŠ¨ã€‘æˆæƒï¼Ÿ](https://t.zsxq.com/06AEQfA2j)
- [11ã€å•ç‚¹ç™»å½•ç•Œé¢ï¼Œå¦‚ä½•è¿›è¡Œã€è‡ªåŠ¨ã€‘æˆæƒï¼Ÿ](https://t.zsxq.com/06JIQvrrN)
- [12ã€åŸºäºã€æˆæƒç ã€‘æ¨¡å¼ï¼Œå¦‚ä½•è·å¾— Token ä»¤ç‰Œï¼Ÿ](https://t.zsxq.com/06jEQZNfE)
- [13ã€åŸºäºã€å¯†ç ã€‘æ¨¡å¼ï¼Œå¦‚ä½•è·å¾— Token ä»¤ç‰Œï¼Ÿ](https://t.zsxq.com/06aEynUZF)
- [14ã€å¦‚ä½•æ ¡éªŒã€åˆ·æ–°ã€åˆ é™¤è®¿é—®ä»¤ç‰Œï¼Ÿ](https://t.zsxq.com/06MbM3n2v)

## OAuth 2.0 æ˜¯ä»€ä¹ˆï¼Ÿ

OAuth 2.0 çš„æ¦‚å¿µè®²è§£ï¼Œå¯ä»¥é˜…è¯»å¦‚ä¸‹ä¸‰ç¯‡æ–‡ç« ï¼š

- [ã€Šç†è§£ OAuth 2.0ã€‹](https://www.iocoder.cn/Fight/ruanyifeng-oauth_2_0/?self)
- [ã€ŠOAuth 2.0 çš„ä¸€ä¸ªç®€å•è§£é‡Šã€‹](https://www.iocoder.cn/Fight/ruanyifeng-oauth_design/?self)
- [ã€ŠOAuth 2.0 çš„å››ç§æ–¹å¼ã€‹](https://www.iocoder.cn/Fight/ruanyifeng-oauth-grant-types/?self)

é‡ç‚¹æ˜¯ç†è§£ **æˆæƒç æ¨¡å¼** å’Œ **å¯†ç æ¨¡å¼**ï¼Œå®ƒä»¬æ˜¯æœ€å¸¸ç”¨çš„ä¸¤ç§æˆæƒæ¨¡å¼ã€‚

æœ¬æ–‡ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåŸºäºå®ƒä»¬ï¼Œåˆ†åˆ«å®ç° SSO å•ç‚¹ç™»å½•ã€‚

## OAuth 2.0 æˆæƒæ¨¡å¼çš„é€‰æ‹©ï¼Ÿ

æˆæƒæ¨¡å¼çš„é€‰æ‹©ï¼Œå…¶å®éå¸¸ç®€å•ï¼Œæ€»ç»“èµ·æ¥å°±æ˜¯ä¸€å¼ å›¾ï¼š

![æˆæƒæ¨¡å¼çš„é€‰æ‹©](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533261.png)

é—®é¢˜ä¸€ï¼šä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentialsï¼‰ï¼Ÿ

å¦‚æœä»¤ç‰Œæ‹¥æœ‰è€…æ˜¯**æœºå™¨**çš„æƒ…å†µä¸‹ï¼Œé‚£å°±ä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼ã€‚ ä¾‹å¦‚è¯´ï¼š

- å¼€å‘äº†ä¸€ä¸ªå¼€æ”¾å¹³å°ï¼Œæä¾›ç»™å…¶å®ƒå¤–éƒ¨æœåŠ¡è°ƒç”¨
- å¼€å‘äº†ä¸€ä¸ª RPC æœåŠ¡ï¼Œæä¾›ç»™å…¶å®ƒå†…éƒ¨æœåŠ¡è°ƒç”¨

å®é™…çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬æ¥å…¥å¾®ä¿¡å…¬ä¼—å·æ—¶ï¼Œä¼šä½¿ç”¨ `appid` å’Œ `secret` å‚æ•°ï¼Œ[è·å– Access token ](https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html)è®¿é—®ä»¤ç‰Œã€‚



é—®é¢˜äºŒï¼šä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œä½¿ç”¨å¯†ç æ¨¡å¼ï¼ˆResource Owner Password Credentialsï¼‰ï¼Ÿ

æ¥å…¥çš„ Client å®¢æˆ·ç«¯ï¼Œæ˜¯å±äº**è‡ªå·±**çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨å¯†ç æ¨¡å¼ã€‚ ä¾‹å¦‚è¯´ï¼š

- å®¢æˆ·ç«¯æ˜¯ä½ è‡ªå·±å…¬å¸çš„ App æˆ–ç½‘é¡µï¼Œç„¶åæˆæƒæœåŠ¡ä¹Ÿæ˜¯ä½ å…¬å¸çš„

ä¸è¿‡ï¼Œå¦‚æœå®¢æˆ·ç«¯æ˜¯**ç¬¬ä¸‰æ–¹**çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¯†ç æ¨¡å¼çš„è¯ï¼Œè¯¥å®¢æˆ·ç«¯æ˜¯å¯ä»¥æ‹¿åˆ°ç”¨æˆ·çš„è´¦å·ã€å¯†ç ï¼Œå­˜åœ¨å®‰å…¨çš„é£é™©ï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨æˆæƒç æˆ–ç®€åŒ–æ¨¡å¼ã€‚



é—®é¢˜ä¸‰ï¼šä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œä½¿ç”¨æˆæƒç æ¨¡å¼ï¼ˆAuthorization Codeï¼‰ï¼Ÿ

æ¥å…¥çš„ Client å®¢æˆ·ç«¯ï¼Œæ˜¯å±äº**ç¬¬ä¸‰æ–¹**çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æˆæƒç æ¨¡å¼ã€‚ä¾‹å¦‚è¯´ï¼š

- å®¢æˆ·ç«¯æ˜¯ä½ è‡ªå·±å…¬å¸çš„ App æˆ–ç½‘é¡µï¼Œä½œä¸ºç¬¬ä¸‰æ–¹ï¼Œæ¥å…¥ [å¾®ä¿¡ ](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)ã€[QQ ](https://wiki.connect.qq.com/oauth2-0ç®€ä»‹)ã€[é’‰é’‰ ](https://open.dingtalk.com/document/mobile-app-guide/mobile-application-access)ç­‰ç­‰è¿›è¡Œ OAuth 2.0 ç™»å½•

å½“ç„¶ï¼Œå¦‚æœå®¢æˆ·ç«¯æ˜¯**è‡ªå·±**çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨æˆæƒç æ¨¡å¼ã€‚ä¾‹å¦‚è¯´ï¼š

- å®¢æˆ·ç«¯æ˜¯è…¾è®¯æ——ä¸‹çš„å„ç§æ¸¸æˆï¼Œå¯ä½¿ç”¨å¾®ä¿¡ã€QQï¼Œæ¥å…¥ [å¾®ä¿¡ ](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html)ã€[QQ ](https://wiki.connect.qq.com/oauth2-0ç®€ä»‹)ç­‰ç­‰è¿›è¡Œ OAuth 2.0 ç™»å½•
- å®¢æˆ·ç«¯æ˜¯å…¬å¸å†…çš„å„ç§ç®¡ç†åå°ï¼ˆERPã€OAã€CRM ç­‰ï¼‰ï¼Œè·³è½¬åˆ°ç»Ÿä¸€çš„ SSO å•ç‚¹ç™»å½•ï¼Œä½¿ç”¨æˆæƒç æ¨¡å¼è¿›è¡Œæˆæƒ



é—®é¢˜å››ï¼šä»€ä¹ˆåœºæ™¯ä¸‹ï¼Œä½¿ç”¨ç®€åŒ–æ¨¡å¼ï¼ˆImplicitï¼‰ï¼Ÿ

ç®€åŒ–æ¨¡å¼ï¼Œ**ç®€åŒ–** çš„æ˜¯æˆæƒç æ¨¡å¼çš„æµç¨‹çš„ **ç¬¬äºŒæ­¥**ï¼Œå·®å¼‚åœ¨äºï¼š

- æˆæƒç æ¨¡å¼ï¼šæˆæƒå®Œæˆåï¼Œè·å¾—çš„æ˜¯ code æˆæƒç ï¼Œéœ€è¦ Server Side æœåŠ¡ç«¯ä½¿ç”¨è¯¥æˆæƒç ï¼Œå†å‘æˆæƒæœåŠ¡å™¨è·å– Access Token è®¿é—®ä»¤ç‰Œ
- ç®€åŒ–æ¨¡å¼ï¼šæˆæƒå®Œæˆåï¼ŒClient Side å®¢æˆ·ç«¯ç›´æ¥è·å¾— Access Token è®¿é—®ä»¤ç‰Œ

æš‚æ—¶æ²¡æœ‰ç‰¹åˆ«å¥½çš„æ¡ˆä¾‹ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹å¦‚ä¸‹æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥ä¸çœ‹ï¼š

- [ã€ŠQQ OAuth 2.0 å¼€å‘æŒ‡å®š â€”â€” å¼€å‘æ”»ç•¥_Client-sideã€‹](https://wiki.connect.qq.com/å¼€å‘æ”»ç•¥_client-side)
- [ã€Šç™¾åº¦ OAuth â€”â€” Implicit Grant æˆæƒã€‹](http://developer.baidu.com/wiki/index.php?title=docs/oauth/implicit)



é—®é¢˜äº”ï¼šè¯¥é¡¹ç›®ä¸­ï¼Œä½¿ç”¨äº†å“ªäº›æˆæƒæ¨¡å¼ï¼Ÿ

![é¡¹ç›®ä½¿ç”¨çš„æˆæƒæ¨¡å¼](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533699.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåˆ†æˆ **å¤–éƒ¨æˆæƒ** å’Œ **å†…éƒ¨ç™»å½•** ä¸¤ç§æ–¹å¼ã€‚

â‘  çº¢è‰²çš„â€œå¤–éƒ¨æˆæƒâ€ï¼šåŸºäºã€æˆæƒç æ¨¡å¼ã€‘ï¼Œå®ç° SSO å•ç‚¹ç™»å½•ï¼Œå°†ç”¨æˆ·æˆæƒç»™æ¥å…¥çš„å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯å¯ä»¥æ˜¯å†…éƒ¨çš„å…¶å®ƒç®¡ç†ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–éƒ¨çš„ç¬¬ä¸‰æ–¹ã€‚

â‘¡ ç»¿è‰²çš„â€œå†…éƒ¨ç™»å½•â€ï¼šç®¡ç†åå°çš„ç™»å½•æ¥å£ï¼Œè¿˜æ˜¯é‡‡ç”¨ä¼ ç»Ÿçš„ [`/admin-api/system/auth/login` ](https://github.com/YunaiV/ruoyi-vue-pro/blob/master/yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/auth/AuthController.java#L61-L67)è´¦å·å¯†ç ç™»å½•ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨ã€å¯†ç æ¨¡å¼ã€‘ï¼Œä¸»è¦è€ƒè™‘é™ä½å¤§å®¶çš„å­¦ä¹ æˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰å°†ç”¨æˆ·æˆæƒç»™å…¶å®ƒç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·åšå·²ç»å¯ä»¥å¾ˆå¥½çš„æ»¡è¶³ä¸šåŠ¡çš„éœ€è¦ã€‚å½“ç„¶ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥å°†ç®¡ç†åå°ä½œä¸ºä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä½¿ç”¨ã€å¯†ç æ¨¡å¼ã€‘è¿›è¡Œæˆæƒã€‚

å¦å¤–ï¼Œè€ƒè™‘åˆ° OAuth 2.0 ä½¿ç”¨çš„è®¿é—®ä»¤ç‰Œ + åˆ·æ–°ä»¤ç‰Œå¯ä»¥æä¾›æ›´å¥½çš„å®‰å…¨æ€§ï¼Œæ‰€ä»¥å³ä½¿æ˜¯ä¼ ç»Ÿçš„è´¦å·å¯†ç ç™»å½•ï¼Œä¹Ÿå¤ç”¨äº†å®ƒä½œä¸ºä»¤ç‰Œçš„å®ç°ã€‚

## OAuth 2.0 æŠ€æœ¯é€‰å‹ï¼Ÿ

å®ç° OAuth 2.0 çš„åŠŸèƒ½ï¼Œä¸€èˆ¬é‡‡ç”¨ [Spring Security OAuth ](https://spring.io/projects/spring-security-oauth)æˆ– [Spring Authorization Server ](https://spring.io/projects/spring-authorization-server)(SAS) æ¡†æ¶ï¼Œå‰è€…å·²åºŸå¼ƒï¼Œè¢«åè€…æ‰€æ›¿ä»£ã€‚ä½†æ˜¯ä½¿ç”¨å®ƒä»¬ï¼Œä¼šé¢ä¸´ä¸‰å¤§é—®é¢˜ï¼š

- å­¦ä¹ æˆæœ¬å¤§ï¼šSAS æ˜¯æ–°å‡ºçš„æ¡†æ¶ï¼Œå…¥é—¨å®¹æ˜“ç²¾é€šéš¾ï¼Œå¼•å…¥é¡¹ç›®ä¸­éœ€è¦èŠ±è´¹ 1-2 å‘¨æ·±å…¥å­¦ä¹ 
- æ’æŸ¥é—®é¢˜éš¾ï¼šä½¿ç”¨ç¢°åˆ°é—®é¢˜æ—¶ï¼Œå¾€å¾€éœ€è¦è°ƒè¯•åˆ°æºç å±‚é¢ï¼Œå›¢é˜Ÿåªæœ‰ä¸ªåˆ«äººå…·å¤‡è¿™ç§èƒ½åŠ›
- å®šåˆ¶æˆæœ¬é«˜ï¼šæ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œæƒ³è¦åœ¨ SAS ä¸Šå®šåˆ¶åŠŸèƒ½ï¼Œå¯¹æºç è¦æœ‰ä¸é”™çš„æŒæ§åŠ›ï¼Œéš¾åº¦å¯èƒ½è¿‡å¤§

âš” å› æ­¤ï¼Œé¡¹ç›®å‚è€ƒå¤šä¸ª OAuth 2.0 æ¡†æ¶ï¼Œ**è‡ªç ”**å®ç° OAuth 2.0 çš„åŠŸèƒ½ï¼Œå…·å¤‡å­¦ä¹ æˆæœ¬å°ã€æ’æŸ¥é—®é¢˜å®¹æ˜“ã€å®šåˆ¶æˆæœ¬ä½çš„ä¼˜ç‚¹ï¼Œæ”¯æŒå¤šç§æˆæƒæ¨¡å¼ï¼Œå¹¶å†…ç½® SSO å•ç‚¹ç™»å½•çš„åŠŸèƒ½ã€‚

å‹æƒ…æç¤ºï¼šå…·å¤‡ä¸€å®šè§„æ¨¡çš„äº’è”ç½‘å…¬å¸ï¼ŒåŸºæœ¬ä¸ä¼šç›´æ¥é‡‡ç”¨ Spring Security OAuth æˆ– Spring Authorization Server æ¡†æ¶ï¼Œä¹Ÿæ˜¯é‡‡ç”¨è‡ªç ”çš„æ–¹å¼ï¼Œæ›´å¥½çš„æ»¡è¶³è‡ªèº«çš„ä¸šåŠ¡éœ€æ±‚ä¸æŠ€æœ¯æ‹“å±•ã€‚

ğŸ™‚ å¦å¤–ï¼Œé€šè¿‡å­¦ä¹ é¡¹ç›®çš„ OAuth 2.0 å®ç°ï¼Œå¯ä»¥è¿›ä¸€æ­¥åŠ æ·±å¯¹ OAuth 2.0 çš„ç†è§£ï¼ŒçŸ¥å…¶ç„¶ã€çŸ¥å…¶æ‰€ä»¥ç„¶ï¼

æœ€ç»ˆå®ç°çš„æ•´ä½“æ¶æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æ•´ä½“æ¶æ„](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533577.png)

è¯¦ç»†çš„ä»£ç å®ç°ï¼Œæˆ‘ä»¬åœ¨è§†é¢‘ä¸­è¿›è¡Œè®²è§£ã€‚

## å¦‚ä½•å®ç° SSO å•ç‚¹ç™»å½•ï¼Ÿ

### å®æˆ˜ä¸€ï¼šåŸºäºæˆæƒç æ¨¡å¼ï¼Œå®ç° SSO å•ç‚¹ç™»å½•

ç¤ºä¾‹ä»£ç è§ [curleygsso-demo-by-code ]æ¨¡å—ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æ•´ä½“æµç¨‹](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533745.png)

å…·ä½“çš„ä½¿ç”¨æµç¨‹å¦‚ä¸‹ï¼š

**â‘  ç¬¬ä¸€æ­¥**ï¼Œåˆ†åˆ«å¯åŠ¨ `curleyg` é¡¹ç›®çš„å‰ç«¯å’Œåç«¯ã€‚

**â‘¡ ç¬¬äºŒæ­¥**ï¼Œè®¿é—® [ç³»ç»Ÿç®¡ç† -> OAuth 2.0 -> åº”ç”¨ç®¡ç† ](http://127.0.0.1:1024/system/oauth2/oauth2/application)èœå•ï¼Œæ–°å¢ä¸€ä¸ªåº”ç”¨ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Œä¿¡æ¯å¦‚ä¸‹å›¾ï¼š

![æˆæƒç æ¨¡å¼çš„å®¢æˆ·ç«¯ä¿¡æ¯](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533387.png)

- å®¢æˆ·ç«¯ç¼–å·ï¼š`curleyg-sso-demo-by-code`
- å®¢æˆ·ç«¯å¯†é’¥ï¼š`test`
- åº”ç”¨åï¼š`åŸºäºæˆæƒç æ¨¡å¼ï¼Œå¦‚ä½•å®ç° SSO å•ç‚¹ç™»å½•ï¼Ÿ`
- æˆæƒç±»å‹ï¼š`authorization_code`ã€`refresh_token`
- æˆæƒèŒƒå›´ï¼š`user.read`ã€`user.write`
- å¯é‡å®šå‘çš„ URI åœ°å€ï¼š`http://127.0.0.1:18080`

psï¼šå¦‚æœå·²ç»æœ‰è¿™ä¸ªå®¢æˆ·ç«¯ï¼Œå¯ä»¥ä¸ç”¨æ–°å¢ã€‚

**â‘¢ ç¬¬ä¸‰æ­¥**ï¼Œè¿è¡Œ [SSODemoApplication ]ç±»ï¼Œå¯åŠ¨æ¥å…¥æ–¹çš„é¡¹ç›®ï¼Œå®ƒå·²ç»åŒ…å«å‰ç«¯å’Œåç«¯éƒ¨åˆ†ã€‚å¯åŠ¨æˆåŠŸçš„æ—¥å¿—å¦‚ä¸‹ï¼š

å‹æƒ…æç¤ºï¼šå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Vue3 + element-plus çš„å‰ç«¯é¡¹ç›®ï¼Œä¸€å®šè¦æ“ä½œï¼ï¼ï¼

éœ€è¦æŠŠ curleyg-sso-demo-by-code çš„ `index.html` æ–‡ä»¶ä¸­çš„ http://localhost:1314/ssoLogin.html æ”¹æˆ å‰ç«¯é¡¹ç›®è·¯å¾„ï¼ï¼ï¼å¦åˆ™åœ¨åç»­çš„â€œæˆæƒå›è°ƒâ€æ—¶ï¼Œä¼šè·³è½¬å¤±è´¥å™¢ï¼ï¼ï¼

```bash
2022-10-01 21:24:35.572  INFO 60265 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 18080 (http) with context path ''
```

**â‘£ ç¬¬å››æ­¥**ï¼Œæµè§ˆå™¨è®¿é—® [http://127.0.0.1:18080/index.html ](http://127.0.0.1:18080/index.html)åœ°å€ï¼Œè¿›å…¥æ¥å…¥æ–¹çš„ index.html é¦–é¡µã€‚å› ä¸ºæš‚æœªç™»å½•ï¼Œå¯ä»¥ç‚¹å‡»ã€Œè·³è½¬ã€æŒ‰é’®ï¼Œè·³è½¬åˆ° `ruoyi-vue-pro` é¡¹ç›®çš„ SSO å•ç‚¹ç™»å½•é¡µã€‚

![æˆæƒç æ¨¡å¼çš„æœªç™»å½•é¦–é¡µ](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533315.png)

ç–‘é—®ï¼šä¸ºä»€ä¹ˆæ²¡æœ‰è·³è½¬åˆ° SSO å•ç‚¹ç™»å½•é¡µï¼Œè€Œæ˜¯è·³è½¬åˆ° ruoyi-vue-pro é¡¹ç›®çš„ç™»å½•é¡µï¼Ÿ

å› ä¸ºåœ¨ `ruoyi-vue-pro` é¡¹ç›®ä¹Ÿæœªç™»å½•ï¼Œæ‰€ä»¥å…ˆè·³è½¬åˆ°è¯¥é¡¹ç›®çš„ç™»å½•é¡µï¼Œä½¿ç”¨è´¦å·å¯†ç è¿›è¡Œç™»å½•ã€‚ç™»å½•å®Œæˆåï¼Œä¼šè·³è½¬å› SSO å•ç‚¹ç™»å½•é¡µï¼Œç»§ç»­å®Œæˆ OAuth 2.0 çš„æˆæƒæµç¨‹ã€‚

**â‘¤ ç¬¬äº”æ­¥**ï¼Œå‹¾é€‰ "è®¿é—®ä½ çš„ä¸ªäººä¿¡æ¯" å’Œ "ä¿®æ”¹ä½ çš„ä¸ªäººä¿¡æ¯"ï¼Œç‚¹å‡»ã€ŒåŒæ„æˆæƒã€æŒ‰é’®ï¼Œå®Œæˆ code æˆæƒç çš„ç”³è¯·ã€‚

![åŒæ„æˆæƒ](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533105.png)

**â‘¥ ç¬¬å…­æ­¥**ï¼Œå®Œæˆæˆæƒåï¼Œä¼šè·³è½¬åˆ°æ¥å…¥æ–¹çš„ callback.html å›è°ƒé¡µï¼Œå¹¶åœ¨ URL ä¸Šå¯ä»¥çœ‹åˆ° code æˆæƒç ã€‚

![æˆæƒç æ¨¡å¼çš„å›è°ƒè·³è½¬](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533222.png)

**â‘¦ ç¬¬ä¸ƒæ­¥**ï¼Œç‚¹å‡»ã€Œç¡®è®¤ã€æŒ‰é’®ï¼Œæ¥å…¥æ–¹çš„å‰ç«¯ä¼šä½¿ç”¨ code æˆæƒç ï¼Œå‘æ¥å…¥æ–¹çš„åç«¯è·å– accessToken è®¿é—®ä»¤ç‰Œã€‚

è€Œæ¥å…¥æ–¹çš„åç«¯ï¼Œä½¿ç”¨æ¥æ”¶åˆ°çš„ code æˆæƒç ï¼Œé€šè¿‡è°ƒç”¨ `ruoyi-vue-pro` é¡¹ç›®çš„åç«¯ï¼Œè·å–åˆ° accessToken è®¿é—®ä»¤ç‰Œï¼Œå¹¶æœ€ç»ˆè¿”å›ç»™æ¥å…¥æ–¹çš„å‰ç«¯ã€‚

**â‘§ ç¬¬å…«æ­¥**ï¼Œåœ¨æ¥å…¥æ–¹çš„å‰ç«¯æ‹¿åˆ° accessToken è®¿é—®ä»¤ç‰Œåï¼Œè·³è½¬å›è‡ªå·±çš„ index.html é¦–é¡µï¼Œå¹¶è¿›ä¸€æ­¥ä» `ruoyi-vue-pro` é¡¹ç›®è·å–åˆ°è¯¥ç”¨æˆ·çš„æ˜µç§°ç­‰ä¸ªäººä¿¡æ¯ã€‚åç»­ï¼Œä½ å¯ä»¥æ‰§è¡Œã€Œä¿®æ”¹æ˜µç§°ã€ã€ã€Œåˆ·æ–°ä»¤ç‰Œã€ã€ã€Œé€€å‡ºç™»å½•ã€ç­‰æ“ä½œã€‚

![æˆæƒç æ¨¡å¼çš„ç™»å½•åé¦–é¡µ](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171533612.png)



### æˆæƒç ä»£ç å®ç°åŸç†ï¼š

#### 1.é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªOAuthå®¢æˆ·ç«¯

```java
public class OAuth2ClientDO extends BaseDO {

    /**
     * ç¼–å·ï¼Œæ•°æ®åº“è‡ªå¢
     *
     * ç”±äº SQL Server åœ¨å­˜å‚¨ String ä¸»é”®æœ‰ç‚¹é—®é¢˜ï¼Œæ‰€ä»¥æš‚æ—¶ä½¿ç”¨ Long ç±»å‹
     */
    @TableId
    private Long id;
    /**
     * å®¢æˆ·ç«¯ç¼–å·
     */
    private String clientId;
    /**
     * å®¢æˆ·ç«¯å¯†é’¥
     */
    private String secret;
    /**
     * åº”ç”¨å
     */
    private String name;
    /**
     * åº”ç”¨å›¾æ ‡
     */
    private String logo;
    /**
     * åº”ç”¨æè¿°
     */
    private String description;
    /**
     * åº”ç”¨çŠ¶æ€
     *
     * æšä¸¾ {@link CommonStatusEnum}
     */
    private Integer status;
    /**
     * è®¿é—®ä»¤ç‰Œçš„æœ‰æ•ˆæœŸ
     */
    private Integer accessTokenValiditySeconds;
    /**
     * åˆ·æ–°ä»¤ç‰Œçš„æœ‰æ•ˆæœŸ
     */
    private Integer refreshTokenValiditySeconds;
    /**
     * å¯é‡å®šå‘çš„ URI åœ°å€
     */
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> redirectUris;
    /**
     * æˆæƒç±»å‹ï¼ˆæ¨¡å¼ï¼‰
     *
     * æšä¸¾ {@link OAuth2GrantTypeEnum}
     */
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> authorizedGrantTypes;
    /**
     * æˆæƒèŒƒå›´
     */
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> scopes;
    /**
     * è‡ªåŠ¨æˆæƒçš„ Scope
     *
     * code æˆæƒæ—¶ï¼Œå¦‚æœ scope åœ¨è¿™ä¸ªèŒƒå›´å†…ï¼Œåˆ™è‡ªåŠ¨é€šè¿‡
     */
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> autoApproveScopes;
    /**
     * æƒé™
     */
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> authorities;
    /**
     * èµ„æº
     */
    @TableField(typeHandler = JacksonTypeHandler.class)
    private List<String> resourceIds;
    /**
     * é™„åŠ ä¿¡æ¯ï¼ŒJSON æ ¼å¼
     */
    private String additionalInformation;
```

#### 2.è·å–æˆæƒcode

æ¥å…¥æ–¹éœ€è¦æä¾›ä¸¤ä¸ªé¡µé¢

ä¸€ä¸ªç”¨æ¥è¿›è¡Œè·³è½¬åˆ°å•ç‚¹é¡µé¢ï¼Œå¹¶ä¸”ä¼ é€’åº”ç”¨id,å›è°ƒåœ°å€æˆæƒç±»å‹ï¼Œå¦ä¸€ä¸ªç”¨æ¥æ¥æ”¶codeæˆ–tokenï¼ˆç®€å•æ¨¡å¼ä¼šæŠŠtokenç›´æ¥è¿”å›ï¼‰

##### é¡µé¢ä¸€ï¼š

```js

    /**
     * è·³è½¬å•ç‚¹ç™»å½•
     */
    function ssoLogin() {
      // å¯ä»¥æ”¹å†™æˆï¼Œä½ çš„ clientId  
      const clientId = 'curleyg-sso-demo-by-code'; 
      // å›è°ƒåœ°å€,æ³¨æ„ï¼Œéœ€è¦ä½¿ç”¨ encodeURIComponent ç¼–ç åœ°å€
      const redirectUri = encodeURIComponent('http://127.0.0.1:18080/callback.html'); 
       // 1ï¼‰æˆæƒç æ¨¡å¼ï¼Œå¯¹åº” codeï¼›2ï¼‰ç®€åŒ–æ¨¡å¼ï¼Œå¯¹åº” token è·å–åˆ°code/tokenä¼šæ‹¼æ¥åˆ°ä¸Šé¢çš„é‡å®šå‘åœ°å€ä¸Š
      const responseType = 'code';
		//è·³è½¬åˆ°SSOå•ç‚¹è®¤è¯é¡µé¢
      window.location.href = 'http://localhost:1314/ssoLogin.html?client_id=' + clientId
        + '&redirect_uri=' + redirectUri
        + '&response_type=' + responseType;
    }

```

#####  é¡µé¢äºŒ

```js
$(function () {
        // è·å¾— code æˆæƒç æˆ–token
        const code = $.getUrlParam('code');
        const token = $.getUrlParam('access_token');

        if (code){
            getTokenByCode(code);
        }else if (token){
            setToken(token);
        }else{
            alert('è·å–ä¸åˆ° code,token å‚æ•°ï¼Œè¯·æ’æŸ¥ï¼')
            return;
        }

            // æäº¤
    })
    //é€šè¿‡codeå€¼ï¼Œè®¿é—®åç«¯å°†ç§˜é’¥å¸¦ä¸Šå»è·å–token,è¿”å›è·å–åˆ°çš„token ä½•åˆ·æ–°tokenè®¾ç½®åˆ°æœ¬åœ°ç¼“å­˜ï¼Œå®ç°ç™»å½•
    function getTokenByCode(code){
         // éœ€è¦ä¿®æ”¹æˆï¼Œä½ å›è°ƒçš„åœ°å€ï¼Œå°±æ˜¯åœ¨ index.html æ‹¼æ¥çš„ redirectUri
        const redirectUri = 'http://127.0.0.1:18080/callback.html';
        $.ajax({
            url: "http://127.0.0.1:18080/auth/login-by-code?code=" + code
                + '&redirectUri=' + redirectUri,
            method: 'POST',
            success: function (result) {
                if (result.code !== 0) {
                    alert('è·å¾—è®¿é—®ä»¤ç‰Œå¤±è´¥ï¼ŒåŸå› ï¼š' + result.msg)
                    return;
                }
                alert('è·å¾—è®¿é—®ä»¤ç‰ŒæˆåŠŸï¼ç‚¹å‡»ç¡®è®¤ï¼Œè·³è½¬å›é¦–é¡µ')

                // è®¾ç½®åˆ° localStorage ä¸­
                localStorage.setItem('ACCESS-TOKEN', result.data.access_token);
                localStorage.setItem('REFRESH-TOKEN', result.data.refresh_token);
                // è·³è½¬å›é¦–é¡µ
                window.location.href = '/index.html';
            }
        })
    }

    //ç®€å•æ¨¡å¼ ç›´æ¥è®¾ç½®token è¿”å›åˆ°é¦–é¢
    function setToken(access_token){
        alert('è·å¾—è®¿é—®ä»¤ç‰ŒæˆåŠŸï¼ç‚¹å‡»ç¡®è®¤ï¼Œè·³è½¬å›é¦–é¡µ')

        localStorage.setItem('ACCESS-TOKEN', access_token);
        // è·³è½¬å›é¦–é¡µ
        window.location.href = '/index.html';
    }
```

#### 3.æœåŠ¡ç«¯ æä¾›ä¸€ä¸ªæˆæƒé¡µé¢

```js
  // æ ¹æ®åº”ç”¨çš„id,è·å–æˆæƒé¡µçš„åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯ç™»å½•çŠ¶æ€å°±ä¼šè·å–æˆåŠŸï¼‰ï¼Œæ²¡æœ‰ç™»å½•ä¼šè¿›è¡Œå¯†ç ç™»å½•
    getAuthorize(params.clientId).then(res => {
        client = res.data.client
        console.log(res.data.scopes, 55)
        // è§£æ scope
        let scopes = res.data.scopes

        // 1.1 å¦‚æœ params.scope éç©ºï¼Œåˆ™è¿‡æ»¤ä¸‹è¿”å›çš„ scopes
        for (const scope of scopes) {
            params.scopes.push(scope.key)
        }
        for (const scope of scopes) {
            if (scope.value) {
                loginForm.scopes.push(scope.key)
            }
        }

        //æ¸²æŸ“é¡µé¢çš„æƒé™ä¿¡æ¯
        $(".layui-this").text("ä¸‰æ–¹æˆæƒ(" + res.data.client.name + ")");
        // è·å–ç”¨äºæ”¾ç½®å¤é€‰æ¡†çš„å®¹å™¨
        var checkboxContainer = $('#scopesCheckbox');
        // åŠ¨æ€ç”Ÿæˆå¤é€‰æ¡†
        params.scopes.forEach(function (scope) {
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'scopes'; // è®¾ç½®ç›¸åŒçš„ name
            checkbox.value = scope; // è®¾ç½®å€¼
            checkbox.title = formatScope(scope); // è®¾ç½®æ ‡é¢˜
            checkbox.className = 'layui-input'; // layui æ ·å¼
            checkbox.checked = loginForm.scopes.indexOf(scope) >= 0; // Default select the checkbox
            checkboxContainer.append(checkbox); // æ·»åŠ åˆ°å®¹å™¨ä¸­
            checkboxContainer.append('<br>');
        });
        form.render()

    })


//ç¡®è®¤æˆæƒï¼Œåˆ¤æ–­æ˜¯å¦åŒæ„æˆæƒ
function handleAuthorize(approved, element) {
    let checkedScopes;
    let uncheckedScopes;
    if (approved) { // åŒæ„æˆæƒï¼ŒæŒ‰ç…§ç”¨æˆ·çš„é€‰æ‹©
        checkedScopes = loginForm.scopes
        uncheckedScopes = params.scopes.filter(item => checkedScopes.indexOf(item) === -1)
    } else { // æ‹’ç»ï¼Œåˆ™éƒ½æ˜¯å–æ¶ˆ
        checkedScopes = []
        uncheckedScopes = params.scopes
    }
    // æäº¤æˆæƒçš„è¯·æ±‚
    authorize(params.responseType, params.clientId, params.redirectUri, params.state,
        false, checkedScopes, uncheckedScopes)
        .then(res => {
            const href = res.data
            //åˆ¤æ–­æ˜¯å¦è¿”å›å›è°ƒåœ°å€
            if (!href) {
                console.log('è‡ªåŠ¨æˆæƒæœªé€šè¿‡ï¼')
                return;
            }
            button.load({
                elem: element,
                time: 1500,
                done: function () {
                    //è·³è½¬åˆ°å›è°ƒåœ°å€ä¸Š
                    location.href = href
                }
            })
        })
        .catch(error => {
            // å¤„ç†å¤±è´¥çš„æƒ…å†µ
            popup.failure(error)
        });
}

function getAuthorize(clientId) {
    return new Promise((resolve, reject) => {
        dictTypeMap= common.getDictTypeMap(common.SYSTEM_OAUTH2_SCOPE);
        // å‘èµ·è¯·æ±‚
        $.ajax({
            url: buffer.url() + '/admin-api/system/oauth2/authorize?clientId=' + clientId,
            dataType: 'json',
            type: 'get',
            headers: common.headers(),
            success: function (result) {
                if (result.code === 0) {
                    resolve(result); // è¯·æ±‚æˆåŠŸï¼Œå°†ç»“æœé€šè¿‡ resolve è¿”å›
                } else {
                    const redirect = encodeURIComponent(window.location.pathname + window.location.search + window.location.hash);
                    window.location.href = `/login.html?redirect=${redirect}`;
                    reject(result); // è¯·æ±‚å¤±è´¥ï¼Œé€šè¿‡ reject è¿”å›é”™è¯¯æ¶ˆæ¯
                }
            },
        });
    });
}


//è®¿é—®æœåŠ¡ç«¯ç”Ÿæˆæˆæƒçš„code æˆ– token æ‹¼æ¥åœ¨å›è°ƒåœ°å€ä¸Š
function authorize(responseType, clientId, redirectUri, state,
                   autoApprove, checkedScopes, uncheckedScopes) {
    return new Promise((resolve, reject) => {
        // æ„å»º scopes
        const scopes = {};
        for (const scope of checkedScopes) {
            scopes[scope] = true;
        }
        for (const scope of uncheckedScopes) {
            scopes[scope] = false;
        }
        // å‘èµ·è¯·æ±‚
        $.ajax({
            url: buffer.url() + "/admin-api/system/oauth2/authorize",
            data: {
                response_type: responseType,
                client_id: clientId,
                redirect_uri: redirectUri,
                state: state,
                auto_approve: autoApprove,
                scope: JSON.stringify(scopes)
            },
            headers: {
                "Authorization": "Bearer " + localStorage.getItem(common.AccessTokenKey),
                "Tenant-Id": localStorage.getItem(common.TenantLocalKey),
            },
            dataType: 'json',
            type: 'post',
            success: function (result) {
                if (result.code === 0) {
                    resolve(result); // è¯·æ±‚æˆåŠŸï¼Œå°†ç»“æœé€šè¿‡ resolve è¿”å›
                } else {
                    reject(result); // è¯·æ±‚å¤±è´¥ï¼Œé€šè¿‡ reject è¿”å›é”™è¯¯æ¶ˆæ¯
                }
            },
        });
    });
}

```

### ä¸»è¦å‚ä¸çš„æ¥å£ï¼š

#### **è·å–æˆæƒä¿¡æ¯æ¥å£**

é¦–é€‰è°ƒç”¨éœ€è¦ç™»å½•ï¼Œæ£€éªŒå®¢æˆ·ç«¯ç¼–å·æ˜¯å¦å­˜åœ¨è¿™æ ·çš„åº”ç”¨ï¼Œè¿”å›è¯¥åº”ç”¨çš„æˆæƒä¿¡æ¯ï¼ˆç»“åˆä¹‹å‰çš„æˆæƒä¿¡æ¯ï¼Œè®¾ç½®å‰ç«¯æˆæƒä¿¡æ¯é»˜è®¤é€‰æ‹©ï¼‰

```java
/**
 * å¯¹åº” Spring Security OAuth çš„ AuthorizationEndpoint ç±»çš„ authorize æ–¹æ³•
 */
@GetMapping("/authorize")
@Operation(summary = "è·å¾—æˆæƒä¿¡æ¯", description = "é€‚åˆ code æˆæƒç æ¨¡å¼ï¼Œæˆ–è€… implicit ç®€åŒ–æ¨¡å¼ï¼›åœ¨ sso.vue å•ç‚¹ç™»å½•ç•Œé¢è¢«ã€è·å–ã€‘è°ƒç”¨")
@Parameter(name = "clientId", required = true, description = "å®¢æˆ·ç«¯ç¼–å·", example = "tudou")
public CommonResult<OAuth2OpenAuthorizeInfoRespVO> authorize(@RequestParam("clientId") String clientId) {
    // 0. æ ¡éªŒç”¨æˆ·å·²ç»ç™»å½•ã€‚é€šè¿‡ Spring Security å®ç°

    // 1. è·å¾— Client å®¢æˆ·ç«¯çš„ä¿¡æ¯
    OAuth2ClientDO client = oauth2ClientService.validOAuthClientFromCache(clientId);
    // 2. è·å¾—ç”¨æˆ·å·²ç»æˆæƒçš„ä¿¡æ¯
    List<OAuth2ApproveDO> approves = oauth2ApproveService.getApproveList(getLoginUserId(), getUserType(), clientId);
    // æ‹¼æ¥è¿”å›
    return success(OAuth2OpenConvert.INSTANCE.convert(client, approves));
}
```

#### **æ­£å¼æˆæƒæ¥å£**

å¤„ç†æˆæƒæƒé™å‚æ•°

æ ¡éªŒ responseType æ˜¯å¦æ»¡è¶³ code æˆ–è€… token å€¼

æ ¡éªŒ redirectUri é‡å®šå‘åŸŸåæ˜¯å¦åˆæ³• + æ ¡éªŒ scope æ˜¯å¦åœ¨ Client æˆæƒèŒƒå›´å†…

å‡è®¾ approved ä¸º nullï¼Œè¯´æ˜æ˜¯åœºæ™¯ä¸€

å‡è®¾ approved é nullï¼Œè¯´æ˜æ˜¯åœºæ™¯äºŒ

```java
 /**
     * å¯¹åº” Spring Security OAuth çš„ AuthorizationEndpoint ç±»çš„ approveOrDeny æ–¹æ³•
     *
     * åœºæ™¯ä¸€ï¼šã€è‡ªåŠ¨æˆæƒ autoApprove = trueã€‘
     *      åˆšè¿›å…¥ sso.vue ç•Œé¢ï¼Œè°ƒç”¨è¯¥æ¥å£ï¼Œç”¨æˆ·å†å²å·²ç»ç»™è¯¥åº”ç”¨åšè¿‡å¯¹åº”çš„æˆæƒï¼Œæˆ–è€… OAuth2Client æ”¯æŒè¯¥ scope çš„è‡ªåŠ¨æˆæƒ
     * åœºæ™¯äºŒï¼šã€æ‰‹åŠ¨æˆæƒ autoApprove = falseã€‘
     *      åœ¨ sso.vue ç•Œé¢ï¼Œç”¨æˆ·é€‰æ‹©å¥½ scope æˆæƒèŒƒå›´ï¼Œè°ƒç”¨è¯¥æ¥å£ï¼Œè¿›è¡Œæˆæƒã€‚æ­¤æ—¶ï¼Œapproved ä¸º true æˆ–è€… false
     *
     * å› ä¸ºå‰åç«¯åˆ†ç¦»ï¼ŒAxios æ— æ³•å¾ˆå¥½çš„å¤„ç† 302 é‡å®šå‘ï¼Œæ‰€ä»¥å’Œ Spring Security OAuth ç•¥æœ‰ä¸åŒï¼Œè¿”å›ç»“æœæ˜¯é‡å®šå‘çš„ URLï¼Œå‰©ä½™äº¤ç»™å‰ç«¯å¤„ç†
     */
    @PostMapping("/authorize")
    @Operation(summary = "ç”³è¯·æˆæƒ", description = "é€‚åˆ code æˆæƒç æ¨¡å¼ï¼Œæˆ–è€… implicit ç®€åŒ–æ¨¡å¼ï¼›åœ¨ sso.vue å•ç‚¹ç™»å½•ç•Œé¢è¢«ã€æäº¤ã€‘è°ƒç”¨")
    @Parameters({
            @Parameter(name = "response_type", required = true, description = "å“åº”ç±»å‹", example = "code"),
            @Parameter(name = "client_id", required = true, description = "å®¢æˆ·ç«¯ç¼–å·", example = "tudou"),
            @Parameter(name = "scope", description = "æˆæƒèŒƒå›´", example = "userinfo.read"),
        // ä½¿ç”¨ Map<String, Boolean> æ ¼å¼ï¼ŒSpring MVC æš‚æ—¶ä¸æ”¯æŒè¿™ä¹ˆæ¥æ”¶å‚æ•°
            @Parameter(name = "redirect_uri", required = true, description = "é‡å®šå‘ URI", example = "https://www.iocoder.cn"),
            @Parameter(name = "auto_approve", required = true, description = "ç”¨æˆ·æ˜¯å¦æ¥å—", example = "true"),
            @Parameter(name = "state", example = "1")
    })
    public CommonResult<String> approveOrDeny(@RequestParam("response_type") String responseType,
                                              @RequestParam("client_id") String clientId,
                                              @RequestParam(value = "scope", required = false) String scope,
                                              @RequestParam("redirect_uri") String redirectUri,
                                              @RequestParam(value = "auto_approve") Boolean autoApprove,
                                              @RequestParam(value = "state", required = false) String state) {
        @SuppressWarnings("unchecked")
        Map<String, Boolean> scopes = JsonUtils.parseObject(scope, Map.class);
        scopes = ObjectUtil.defaultIfNull(scopes, Collections.emptyMap());
        // 0. æ ¡éªŒç”¨æˆ·å·²ç»ç™»å½•ã€‚é€šè¿‡ Spring Security å®ç°

        // 1.1 æ ¡éªŒ responseType æ˜¯å¦æ»¡è¶³ code æˆ–è€… token å€¼
        OAuth2GrantTypeEnum grantTypeEnum = getGrantTypeEnum(responseType);
        // 1.2 æ ¡éªŒ redirectUri é‡å®šå‘åŸŸåæ˜¯å¦åˆæ³• + æ ¡éªŒ scope æ˜¯å¦åœ¨ Client æˆæƒèŒƒå›´å†…
        OAuth2ClientDO client = oauth2ClientService.validOAuthClientFromCache(clientId, null,
                grantTypeEnum.getGrantType(), scopes.keySet(), redirectUri);

        // 2.1 å‡è®¾ approved ä¸º nullï¼Œè¯´æ˜æ˜¯åœºæ™¯ä¸€
        if (Boolean.TRUE.equals(autoApprove)) {
            // å¦‚æœæ— æ³•è‡ªåŠ¨æˆæƒé€šè¿‡ï¼Œåˆ™è¿”å›ç©º urlï¼Œå‰ç«¯ä¸è¿›è¡Œè·³è½¬
            if (!oauth2ApproveService.checkForPreApproval(getLoginUserId(), getUserType(), clientId, scopes.keySet())) {
                return success(null);
            }
        } else { // 2.2 å‡è®¾ approved é nullï¼Œè¯´æ˜æ˜¯åœºæ™¯äºŒ
            // å¦‚æœè®¡ç®—åä¸é€šè¿‡ï¼Œåˆ™è·³è½¬ä¸€ä¸ªé”™è¯¯é“¾æ¥
            if (!oauth2ApproveService.updateAfterApproval(getLoginUserId(), getUserType(), clientId, scopes)) {
                return success(OAuth2Utils.buildUnsuccessfulRedirect(redirectUri, responseType, state,
                        "access_denied", "User denied access"));
            }
        }

        // 3.1 å¦‚æœæ˜¯ code æˆæƒç æ¨¡å¼ï¼Œåˆ™å‘æ”¾ code æˆæƒç ï¼Œå¹¶é‡å®šå‘
        List<String> approveScopes = convertList(scopes.entrySet(), Map.Entry::getKey, Map.Entry::getValue);
        if (grantTypeEnum == OAuth2GrantTypeEnum.AUTHORIZATION_CODE) {
            return success(getAuthorizationCodeRedirect(getLoginUserId(), client, approveScopes, redirectUri, state));
        }
        // 3.2 å¦‚æœæ˜¯ token åˆ™æ˜¯ implicit ç®€åŒ–æ¨¡å¼ï¼Œåˆ™å‘é€ accessToken è®¿é—®ä»¤ç‰Œï¼Œå¹¶é‡å®šå‘
        return success(getImplicitGrantRedirect(getLoginUserId(), client, approveScopes, redirectUri, state));
    }
```

åˆ›å»ºcodeæ–¹æ³•,å¹¶ä¸”ä¿å­˜åˆ°system_oauth2_codeè¡¨ä¸­ï¼Œæˆæƒç çš„è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ 5 åˆ†é’Ÿï¼Œæ‹¼æ¥é‡å®šå‘çš„ URL+code

```java
private String getAuthorizationCodeRedirect(Long userId, OAuth2ClientDO client,
                                            List<String> scopes, String redirectUri, String state) {
    // 1. åˆ›å»º code æˆæƒç 
    String authorizationCode = oauth2GrantService.grantAuthorizationCodeForCode(userId, getUserType(), client.getClientId(), scopes,
            redirectUri, state);
    // 2. æ‹¼æ¥é‡å®šå‘çš„ URL
    return OAuth2Utils.buildAuthorizationCodeRedirectUri(redirectUri, authorizationCode, state);
}

```

åˆ›å»ºtokenæ–¹æ³•,å¹¶ä¸”ä¿å­˜åˆ°system_oauth2_access_tokenè¡¨ä¸­

```
private String getImplicitGrantRedirect(Long userId, OAuth2ClientDO client,
                                        List<String> scopes, String redirectUri, String state) {
    // 1. åˆ›å»º access token è®¿é—®ä»¤ç‰Œ
    OAuth2AccessTokenDO accessTokenDO = oauth2GrantService.grantImplicit(userId, getUserType(), client.getClientId(), scopes);
    Assert.notNull(accessTokenDO, "è®¿é—®ä»¤ç‰Œä¸èƒ½ä¸ºç©º"); // é˜²å¾¡æ€§æ£€æŸ¥
    // 2. æ‹¼æ¥é‡å®šå‘çš„ URL
    // noinspection unchecked
    return OAuth2Utils.buildImplicitRedirectUri(redirectUri, accessTokenDO.getAccessToken(), state, accessTokenDO.getExpiresTime(),
            scopes, JsonUtils.parseObject(client.getAdditionalInformation(), Map.class));
}
```

#### æ ¹æ®æˆæƒç è·å–token,åˆ·æ–°token

```java
/**
 * å¯¹åº” Spring Security OAuth çš„ TokenEndpoint ç±»çš„ postAccessToken æ–¹æ³•
 *
 * æˆæƒç  authorization_code æ¨¡å¼æ—¶ï¼šcode + redirectUri + state å‚æ•°
 * å¯†ç  password æ¨¡å¼æ—¶ï¼šusername + password + scope å‚æ•°
 * åˆ·æ–° refresh_token æ¨¡å¼æ—¶ï¼šrefreshToken å‚æ•°
 * å®¢æˆ·ç«¯ client_credentials æ¨¡å¼ï¼šscope å‚æ•°
 * ç®€åŒ– implicit æ¨¡å¼æ—¶ï¼šä¸æ”¯æŒ
 *
 * æ³¨æ„ï¼Œé»˜è®¤éœ€è¦ä¼ é€’ client_id + client_secret å‚æ•°
 */
@PostMapping("/token")
@PermitAll
@Operation(summary = "è·å¾—è®¿é—®ä»¤ç‰Œ", description = "é€‚åˆ code æˆæƒç æ¨¡å¼ï¼Œæˆ–è€… implicit ç®€åŒ–æ¨¡å¼ï¼›åœ¨ sso.vue å•ç‚¹ç™»å½•ç•Œé¢è¢«ã€è·å–ã€‘è°ƒç”¨")
@Parameters({
        @Parameter(name = "grant_type", required = true, description = "æˆæƒç±»å‹", example = "code"),
        @Parameter(name = "code", description = "æˆæƒèŒƒå›´", example = "userinfo.read"),
        @Parameter(name = "redirect_uri", description = "é‡å®šå‘ URI", example = "https://www.iocoder.cn"),
        @Parameter(name = "state", description = "çŠ¶æ€", example = "1"),
        @Parameter(name = "username", example = "tudou"),
        @Parameter(name = "password", example = "cai"), // å¤šä¸ªä½¿ç”¨ç©ºæ ¼åˆ†éš”
        @Parameter(name = "scope", example = "user_info"),
        @Parameter(name = "refresh_token", example = "123424233"),
})
public CommonResult<OAuth2OpenAccessTokenRespVO> postAccessToken(
     HttpServletRequest request,
     @RequestParam("grant_type") String grantType,
     @RequestParam(value = "code", required = false) String code, // æˆæƒç æ¨¡å¼
     @RequestParam(value = "redirect_uri", required = false) String redirectUri, // æˆæƒç æ¨¡å¼
     @RequestParam(value = "state", required = false) String state, // æˆæƒç æ¨¡å¼
     @RequestParam(value = "username", required = false) String username, // å¯†ç æ¨¡å¼
     @RequestParam(value = "password", required = false) String password, // å¯†ç æ¨¡å¼
     @RequestParam(value = "scope", required = false) String scope, // å¯†ç æ¨¡å¼
     @RequestParam(value = "refresh_token", required = false) String refreshToken) { // åˆ·æ–°æ¨¡å¼
    List<String> scopes = OAuth2Utils.buildScopes(scope);
    // 1.1 æ ¡éªŒæˆæƒç±»å‹
    OAuth2GrantTypeEnum grantTypeEnum = OAuth2GrantTypeEnum.getByGrantType(grantType);
    if (grantTypeEnum == null) {
        throw exception0(BAD_REQUEST.getCode(), StrUtil.format("æœªçŸ¥æˆæƒç±»å‹({})", grantType));
    }
    if (grantTypeEnum == OAuth2GrantTypeEnum.IMPLICIT) {
        throw exception0(BAD_REQUEST.getCode(), "Token æ¥å£ä¸æ”¯æŒ implicit æˆæƒæ¨¡å¼");
    }

    // 1.2 æ ¡éªŒå®¢æˆ·ç«¯
    String[] clientIdAndSecret = obtainBasicAuthorization(request);
    OAuth2ClientDO client = oauth2ClientService.validOAuthClientFromCache(clientIdAndSecret[0], clientIdAndSecret[1],
            grantType, scopes, redirectUri);

    // 2. æ ¹æ®æˆæƒæ¨¡å¼ï¼Œè·å–è®¿é—®ä»¤ç‰Œ
    OAuth2AccessTokenDO accessTokenDO;
    switch (grantTypeEnum) {
        case AUTHORIZATION_CODE:
            accessTokenDO = oauth2GrantService.grantAuthorizationCodeForAccessToken(client.getClientId(), code, redirectUri, state);
            break;
        case PASSWORD:
            accessTokenDO = oauth2GrantService.grantPassword(username, password, client.getClientId(), scopes);
            break;
        case CLIENT_CREDENTIALS:
            accessTokenDO = oauth2GrantService.grantClientCredentials(client.getClientId(), scopes);
            break;
        case REFRESH_TOKEN:
            accessTokenDO = oauth2GrantService.grantRefreshToken(refreshToken, client.getClientId());
            break;
        default:
            throw new IllegalArgumentException("æœªçŸ¥æˆæƒç±»å‹ï¼š" + grantType);
    }
    Assert.notNull(accessTokenDO, "è®¿é—®ä»¤ç‰Œä¸èƒ½ä¸ºç©º"); // é˜²å¾¡æ€§æ£€æŸ¥
    return success(OAuth2OpenConvert.INSTANCE.convert(accessTokenDO));
}
```

#### code è·å–tokenå®ç°

```java
 public OAuth2AccessTokenDO grantAuthorizationCodeForAccessToken(String clientId, String code,
                                                                    String redirectUri, String state) {
        OAuth2CodeDO codeDO = oauth2CodeService.consumeAuthorizationCode(code);
        Assert.notNull(codeDO, "æˆæƒç ä¸èƒ½ä¸ºç©º"); // é˜²å¾¡æ€§ç¼–ç¨‹
        // æ ¡éªŒ clientId æ˜¯å¦åŒ¹é…
        if (!StrUtil.equals(clientId, codeDO.getClientId())) {
            throw exception(ErrorCodeConstants.OAUTH2_GRANT_CLIENT_ID_MISMATCH);
        }
        // æ ¡éªŒ redirectUri æ˜¯å¦åŒ¹é…
        if (!StrUtil.equals(redirectUri, codeDO.getRedirectUri())) {
            throw exception(ErrorCodeConstants.OAUTH2_GRANT_REDIRECT_URI_MISMATCH);
        }
        // æ ¡éªŒ state æ˜¯å¦åŒ¹é…
        state = StrUtil.nullToDefault(state, ""); // æ•°æ®åº“ state ä¸º null æ—¶ï¼Œä¼šè®¾ç½®ä¸º "" ç©ºä¸²
        if (!StrUtil.equals(state, codeDO.getState())) {
            throw exception(ErrorCodeConstants.OAUTH2_GRANT_STATE_MISMATCH);
        }

        // åˆ›å»ºè®¿é—®ä»¤ç‰Œ
        return oauth2TokenService.createAccessToken(codeDO.getUserId(), codeDO.getUserType(),
                codeDO.getClientId(), codeDO.getScopes());
    }
```

#### è´¦å·å¯†ç è·å–token

```java
  @Override
    public OAuth2AccessTokenDO grantPassword(String username, String password, String clientId, List<String> scopes) {
        // ä½¿ç”¨è´¦å· + å¯†ç è¿›è¡Œç™»å½•
        AdminUserDO user = adminAuthService.authenticate(username, password);
        Assert.notNull(user, "ç”¨æˆ·ä¸èƒ½ä¸ºç©ºï¼"); // é˜²å¾¡æ€§ç¼–ç¨‹

        // åˆ›å»ºè®¿é—®ä»¤ç‰Œ
        return oauth2TokenService.createAccessToken(user.getId(), UserTypeEnum.ADMIN.getValue(), clientId, scopes);
    }
```

#### åˆ·æ–°token 

```java
 @Override
    @Transactional(rollbackFor = Exception.class)
    public OAuth2AccessTokenDO refreshAccessToken(String refreshToken, String clientId) {
        // æŸ¥è¯¢è®¿é—®ä»¤ç‰Œ
        OAuth2RefreshTokenDO refreshTokenDO = oauth2RefreshTokenMapper.selectByRefreshToken(refreshToken);
        if (refreshTokenDO == null) {
            throw exception0(GlobalErrorCodeConstants.BAD_REQUEST.getCode(), "æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ");
        }

        // æ ¡éªŒ Client åŒ¹é…
        OAuth2ClientDO clientDO = oauth2ClientService.validOAuthClientFromCache(clientId);
        if (ObjectUtil.notEqual(clientId, refreshTokenDO.getClientId())) {
            throw exception0(GlobalErrorCodeConstants.BAD_REQUEST.getCode(), "åˆ·æ–°ä»¤ç‰Œçš„å®¢æˆ·ç«¯ç¼–å·ä¸æ­£ç¡®");
        }

        // ç§»é™¤ç›¸å…³çš„è®¿é—®ä»¤ç‰Œ
        List<OAuth2AccessTokenDO> accessTokenDOs = oauth2AccessTokenMapper.selectListByRefreshToken(refreshToken);
        if (CollUtil.isNotEmpty(accessTokenDOs)) {
            oauth2AccessTokenMapper.deleteByIds(convertSet(accessTokenDOs, OAuth2AccessTokenDO::getId));
            oauth2AccessTokenRedisDAO.deleteList(convertSet(accessTokenDOs, OAuth2AccessTokenDO::getAccessToken));
        }

        // å·²è¿‡æœŸçš„æƒ…å†µä¸‹ï¼Œåˆ é™¤åˆ·æ–°ä»¤ç‰Œ
        if (DateUtils.isExpired(refreshTokenDO.getExpiresTime())) {
            oauth2RefreshTokenMapper.deleteById(refreshTokenDO.getId());
            throw exception0(GlobalErrorCodeConstants.UNAUTHORIZED.getCode(), "åˆ·æ–°ä»¤ç‰Œå·²è¿‡æœŸ");
        }

        // åˆ›å»ºè®¿é—®ä»¤ç‰Œ
        return createOAuth2AccessToken(refreshTokenDO, clientDO);
    }
```



### å®æˆ˜äºŒï¼šåŸºäºå¯†ç æ¨¡å¼ï¼Œå®ç° SSO ç™»å½•

ç¤ºä¾‹ä»£ç è§ [https://gitee.com/yudaocode/yudao-demo/tree/master/yudao-sso-demo-by-password ](https://gitee.com/yudaocode/yudao-demo/tree/master/yudao-sso-demo-by-password)åœ°å€ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![æ•´ä½“æµç¨‹](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171534243.png)

å…·ä½“çš„ä½¿ç”¨æµç¨‹å¦‚ä¸‹ï¼š

**â‘  ç¬¬ä¸€æ­¥**ï¼Œåˆ†åˆ«å¯åŠ¨ `ruoyi-vue-pro` é¡¹ç›®çš„å‰ç«¯å’Œåç«¯ã€‚æ³¨æ„ï¼Œå‰ç«¯éœ€è¦ä½¿ç”¨ Vue2 ç‰ˆæœ¬ï¼Œå› ä¸º Vue3 ç‰ˆæœ¬æš‚æ—¶æ²¡æœ‰å®ç° SSO é¡µé¢ã€‚

**â‘¡ ç¬¬äºŒæ­¥**ï¼Œè®¿é—® [ç³»ç»Ÿç®¡ç† -> OAuth 2.0 -> åº”ç”¨ç®¡ç† ](http://127.0.0.1:1024/system/oauth2/oauth2/application)èœå•ï¼Œæ–°å¢ä¸€ä¸ªåº”ç”¨ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Œä¿¡æ¯å¦‚ä¸‹å›¾ï¼š

![å¯†ç æ¨¡å¼çš„å®¢æˆ·ç«¯ä¿¡æ¯](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171534495.png)

- å®¢æˆ·ç«¯ç¼–å·ï¼š`yudao-sso-demo-by-password`
- å®¢æˆ·ç«¯å¯†é’¥ï¼š`test`
- åº”ç”¨åï¼š`åŸºäºå¯†ç æ¨¡å¼ï¼Œå¦‚ä½•å®ç° SSO å•ç‚¹ç™»å½•ï¼Ÿ`
- æˆæƒç±»å‹ï¼š`password`ã€`refresh_token`
- æˆæƒèŒƒå›´ï¼š`user.read`ã€`user.write`
- å¯é‡å®šå‘çš„ URI åœ°å€ï¼š`http://127.0.0.1:18080`

psï¼šå¦‚æœå·²ç»æœ‰è¿™ä¸ªå®¢æˆ·ç«¯ï¼Œå¯ä»¥ä¸ç”¨æ–°å¢ã€‚

**â‘¢ ç¬¬ä¸‰æ­¥**ï¼Œè¿è¡Œ [SSODemoApplication ](https://gitee.com/yudaocode/yudao-demo/blob/master/yudao-sso-demo-by-password/src/main/java/cn/iocoder/yudao/ssodemo/SSODemoApplication.java)ç±»ï¼Œå¯åŠ¨æ¥å…¥æ–¹çš„é¡¹ç›®ï¼Œå®ƒå·²ç»åŒ…å«å‰ç«¯å’Œåç«¯éƒ¨åˆ†ã€‚å¯åŠ¨æˆåŠŸçš„æ—¥å¿—å¦‚ä¸‹ï¼š

```bash
2022-10-04 21:24:35.572  INFO 60265 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 18080 (http) with context path ''
```

**â‘£ ç¬¬å››æ­¥**ï¼Œæµè§ˆå™¨è®¿é—® [http://127.0.0.1:18080/index.html ](http://127.0.0.1:18080/index.html)åœ°å€ï¼Œè¿›å…¥æ¥å…¥æ–¹çš„ index.html é¦–é¡µã€‚å› ä¸ºæš‚æœªç™»å½•ï¼Œå¯ä»¥ç‚¹å‡»ã€Œè·³è½¬ã€æŒ‰é’®ï¼Œè·³è½¬åˆ° login.html ç™»å½•é¡µã€‚

![å¯†ç æ¨¡å¼çš„æœªç™»å½•é¦–é¡µ](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171534044.png)

![å¯†ç æ¨¡å¼çš„æœªç™»å½•é¦–é¡µ2](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171534226.png)

**â‘¤ ç¬¬äº”æ­¥**ï¼Œç‚¹å‡»ã€Œç™»å½•ã€æŒ‰é’®ï¼Œè°ƒç”¨ `ruoyi-vue-pro` é¡¹ç›®çš„åç«¯ï¼Œè·å–åˆ° accessToken è®¿é—®ä»¤ç‰Œï¼Œå®Œæˆç™»å½•æ“ä½œã€‚

![å¯†ç æ¨¡å¼çš„å‘èµ·ç™»å½•.png](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171534196.png)

**â‘¥ ç¬¬å…­æ­¥**ï¼Œç™»å½•å®Œæˆåï¼Œè·³è½¬å›è‡ªå·±çš„ index.html é¦–é¡µï¼Œå¹¶è¿›ä¸€æ­¥ä» `ruoyi-vue-pro` é¡¹ç›®è·å–åˆ°è¯¥ç”¨æˆ·çš„æ˜µç§°ç­‰ä¸ªäººä¿¡æ¯ã€‚åç»­ï¼Œä½ å¯ä»¥æ‰§è¡Œã€Œä¿®æ”¹æ˜µç§°ã€ã€ã€Œåˆ·æ–°ä»¤ç‰Œã€ã€ã€Œé€€å‡ºç™»å½•ã€ç­‰æ“ä½œã€‚

![å¯†ç æ¨¡å¼çš„ç™»å½•åé¦–é¡µ](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171534555.png)



## OAuth 2.0 è¡¨ç»“æ„

![è¡¨ç»“æ„](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412171534086.png)

