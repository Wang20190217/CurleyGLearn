# åŠŸèƒ½æƒé™

## ğŸ‘ ç›¸å…³è§†é¢‘æ•™ç¨‹

- [åŠŸèƒ½æƒé™ 01ï¼šå¦‚ä½•è®¾è®¡ä¸€å¥—æƒé™ç³»ç»Ÿï¼Ÿ](https://t.zsxq.com/07nYzrfyz)
- [åŠŸèƒ½æƒé™ 02ï¼šå¦‚ä½•å®ç°èœå•çš„åˆ›å»ºï¼Ÿ](https://t.zsxq.com/07IuNBmAq)
- [åŠŸèƒ½æƒé™ 03ï¼šå¦‚ä½•å®ç°è§’è‰²çš„åˆ›å»ºï¼Ÿ](https://t.zsxq.com/07f6AuJuZ)
- [åŠŸèƒ½æƒé™ 04ï¼šå¦‚ä½•ç»™ç”¨æˆ·åˆ†é…æƒé™ â€”â€” å°†èœå•èµ‹äºˆè§’è‰²ï¼Ÿ](https://t.zsxq.com/07uJqV7Y3)
- [åŠŸèƒ½æƒé™ 05ï¼šå¦‚ä½•ç»™ç”¨æˆ·åˆ†é…æƒé™ â€”â€” å°†è§’è‰²èµ‹äºˆç”¨æˆ·ï¼Ÿ](https://t.zsxq.com/07YBe6QjA)
- [åŠŸèƒ½æƒé™ 06ï¼šåç«¯å¦‚ä½•å®ç° URL æƒé™çš„æ ¡éªŒï¼Ÿ](https://t.zsxq.com/072ZVJurz)
- [åŠŸèƒ½æƒé™ 07ï¼šå‰ç«¯å¦‚ä½•å®ç°èœå•çš„åŠ¨æ€åŠ è½½ï¼Ÿ](https://t.zsxq.com/07rnMRRn2)
- [åŠŸèƒ½æƒé™ 08ï¼šå‰ç«¯å¦‚ä½•å®ç°æŒ‰é’®çš„æƒé™æ ¡éªŒï¼Ÿ](https://t.zsxq.com/072JeIUfY)

## 1. RBAC æƒé™æ¨¡å‹

ç³»ç»Ÿé‡‡ç”¨ RBAC æƒé™æ¨¡å‹ï¼Œå…¨ç§°æ˜¯ Role-Based Access Control åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚

![æƒé™æ¨¡å‹](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412251800419.png)

ç®€å•æ¥è¯´ï¼Œæ¯ä¸ªç”¨æˆ·æ‹¥æœ‰è‹¥å¹²è§’è‰²ï¼Œæ¯ä¸ªè§’è‰²æ‹¥æœ‰è‹¥å¹²ä¸ªèœå•ï¼Œèœå•ä¸­å­˜åœ¨èœå•æƒé™ã€æŒ‰é’®æƒé™ã€‚è¿™æ ·ï¼Œå°±å½¢æˆäº† **â€œç”¨æˆ·<->è§’è‰²<->èœå•â€** çš„æˆæƒæ¨¡å‹ã€‚ åœ¨è¿™ç§æ¨¡å‹ä¸­ï¼Œç”¨æˆ·ä¸è§’è‰²ã€è§’è‰²ä¸èœå•ä¹‹é—´æ„æˆäº†å¤šå¯¹å¤šçš„å…³ç³»ï¼Œå¦‚ä¸‹å›¾ï¼š

![æƒé™æ¨¡å‹](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412251800239.png)

## 2. Token è®¤è¯æœºåˆ¶

> Spring Securityå­¦ä¹ 

å®‰å…¨æ¡†æ¶ä½¿ç”¨çš„æ˜¯ Spring Security + Token æ–¹æ¡ˆï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Token è®¤è¯æœºåˆ¶](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412251950354.png)

â‘  å‰ç«¯è°ƒç”¨ç™»å½•æ¥å£ï¼Œä½¿ç”¨è´¦å·å¯†ç è·å¾—åˆ°è®¤è¯ Tokenï¼Œä»¥åŠç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€‚

![image-20241225193454137](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412251934156.png)

å“åº”ç¤ºä¾‹å¦‚ä¸‹ï¼š

```json
{
  "code":0,
  "msg":"",
  "data":{
    "token":"d2a3cdbc6c53470db67a582bd115103f",
    "refreshToken":"d2a3cdbc6c53470db67a582bd115103f", 
    "avatar": "http://127.0.0.1:48080/admin-api/infra/file/4/get/2024071809/79fda1eba543657e3c092e7c576ee0ab.png",
    "id": "1",
    "name": "CurleyG",
    "position": "",
    "type": "user",
  }
}
```

- ç®¡ç†åå°çš„ç™»å½•å®ç°

```java
  @Override
    public AuthLoginRespVO login(AuthLoginReqVO reqVO) {
        // ä½¿ç”¨è´¦å·å¯†ç ï¼Œè¿›è¡Œç™»å½•,æ ¡éªŒç”¨æˆ·ï¼Œå¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯
        AdminUserDO user = authenticate(reqVO.getUsername(),reqVO.getPassword());

        // å¦‚æœ socialType éç©ºï¼Œè¯´æ˜éœ€è¦ç»‘å®šç¤¾äº¤ç”¨æˆ·
        if (reqVO.getSocialType() != null) {
            socialUserService.bindSocialUser(new SocialUserBindReqDTO(user.getId(), getUserType().getValue(),
                    reqVO.getSocialType(), reqVO.getSocialCode(), reqVO.getSocialState()));
        }
        // åˆ›å»º Token ä»¤ç‰Œï¼Œè®°å½•ç™»å½•æ—¥å¿—
        return createTokenAfterLoginSuccess(user.getId(), reqVO.getUsername(), LoginLogTypeEnum.LOGIN_USERNAME);
    }
```

- ç”¨æˆ· App çš„ç™»å½•å®ç°

  ```java
      @Override
      public AppAuthLoginRespVO login(AppAuthLoginReqVO reqVO) {
          // ä½¿ç”¨æ‰‹æœº + å¯†ç ï¼Œè¿›è¡Œç™»å½•ã€‚
          MemberUserDO user = login0(reqVO.getMobile(), reqVO.getPassword());
  
          // å¦‚æœ socialType éç©ºï¼Œè¯´æ˜éœ€è¦ç»‘å®šç¤¾äº¤ç”¨æˆ·
          String openid = null;
          if (reqVO.getSocialType() != null) {
              openid = socialUserApi.bindSocialUser(new SocialUserBindReqDTO(user.getId(), getUserType().getValue(),
                      reqVO.getSocialType(), reqVO.getSocialCode(), reqVO.getSocialState()));
          }
  
          // åˆ›å»º Token ä»¤ç‰Œï¼Œè®°å½•ç™»å½•æ—¥å¿—
          return createTokenAfterLoginSuccess(user, reqVO.getMobile(), LoginLogTypeEnum.LOGIN_MOBILE, openid);
      }
  
  ```

  

**ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨ Spring Security å†…ç½®çš„è¡¨å•ç™»å½•ï¼Ÿ**

Spring Security çš„ç™»å½•æ‹“å±•èµ·æ¥ä¸æ–¹ä¾¿ï¼Œä¾‹å¦‚è¯´éªŒè¯ç ã€ä¸‰æ–¹ç™»å½•ç­‰ç­‰ã€‚

Token å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå¯¹åº” `system_oauth2_access_token` è®¿é—®ä»¤ç‰Œè¡¨çš„ `id` å­—æ®µã€‚è€ƒè™‘åˆ°è®¿é—®çš„æ€§èƒ½ï¼Œç¼“å­˜åœ¨ Redis çš„ [`oauth2_access_token:%s` ]é”®ä¸­ã€‚



**ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨ JWT(JSON Web Token)ï¼Ÿ**

JWT æ˜¯æ— çŠ¶æ€çš„ï¼Œæ— æ³•å®ç° Token çš„ä½œåºŸï¼Œä¾‹å¦‚è¯´ç”¨æˆ·ç™»å‡ºç³»ç»Ÿã€ä¿®æ”¹å¯†ç ç­‰ç­‰åœºæ™¯ã€‚

é»˜è®¤é…ç½®ä¸‹ï¼ŒToken æœ‰æ•ˆæœŸä¸º 30 å¤©ï¼Œå¯é€šè¿‡ `system_oauth2_client` è¡¨ä¸­ `client_id = default` çš„è®°å½•è¿›è¡Œè‡ªå®šä¹‰ï¼š

![ è¡¨](https://curleyg-1311489005.cos.ap-shanghai.myqcloud.com/202412251950983.png)

- ä¿®æ”¹ `access_token_validity_seconds` å­—æ®µï¼Œè®¾ç½®è®¿é—®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ 1800 ç§’ = 30 åˆ†é’Ÿ
- ä¿®æ”¹ `refresh_token_validity_seconds` å­—æ®µï¼Œè®¾ç½®åˆ·æ–°ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ 2592000 ç§’ = 30 å¤©



â‘¡ å½“æ‹¿åˆ°token,æ¯æ¬¡å‰ç«¯è°ƒç”¨å…¶å®ƒæ¥å£ï¼Œéœ€è¦åœ¨è¯·æ±‚å¤´å¸¦ä¸Š Token è¿›è¡Œè®¿é—®ã€‚è¯·æ±‚å¤´æ ¼å¼å¦‚ä¸‹ï¼š

```bash
### Authorization: Bearer ç™»å½•æ—¶è¿”å›çš„ Token
Authorization: Bearer d2a3cdbc6c53470db67a582bd115103f
```

- å…·ä½“çš„ä»£ç å®ç°ï¼Œå¯è§ [TokenAuthenticationFilter ]è¿‡æ»¤å™¨

```java
    @Override
    @SuppressWarnings("NullableProblems")
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain)
            throws ServletException, IOException {
        //ä»è¯·æ±‚å¤´ä¸­è·å–token,è·å–ä¸åˆ°ä»å‚æ•°å½“ä¸­è·å–
        String token = SecurityFrameworkUtils.obtainAuthorization(request,
                securityProperties.getTokenHeader(), securityProperties.getTokenParameter());
        //åˆ¤ç©º
        if (StrUtil.isNotEmpty(token)) {
            //è·å¾—å½“å‰ç”¨æˆ·çš„ç±»å‹ï¼Œå…ˆä»è°ƒç”¨çš„è¯·æ±‚å¤´ä¸­è·å–ï¼Œè·å–ä¸åˆ°ä»URLè·¯å¾„è·å–
            Integer userType = WebFrameworkUtils.getLoginUserType(request);
            try {
                // 1.1 åŸºäº token æ„å»ºç™»å½•ç”¨æˆ·
                LoginUser loginUser = buildLoginUserByToken(token, userType);
                // 1.2 æ¨¡æ‹Ÿ Login åŠŸèƒ½ï¼Œæ–¹ä¾¿æ—¥å¸¸å¼€å‘è°ƒè¯•
                if (loginUser == null) {
                    loginUser = mockLoginUser(request, token, userType);
                }

                // 2. è®¾ç½®å½“å‰ç”¨æˆ·ä¿¡æ¯åˆ°Securityä¸Šä¸‹æ–‡å½“ä¸­
                if (loginUser != null) {
                    SecurityFrameworkUtils.setLoginUser(loginUser, request);
                }
            } catch (Throwable ex) {
                CommonResult<?> result = globalExceptionHandler.allExceptionHandler(request, ex);
                ServletUtils.writeJSON(response, result);
                return;
            }
        }

        // ç»§ç»­è¿‡æ»¤é“¾
        chain.doFilter(request, response);
    }
```

è€ƒè™‘åˆ°ä½¿ç”¨ Postmanã€Swagger è°ƒè¯•æ¥å£æ–¹ä¾¿ï¼Œæä¾›äº† **Token çš„æ¨¡æ‹Ÿæœºåˆ¶**ã€‚è¯·æ±‚å¤´æ ¼å¼å¦‚ä¸‹ï¼š

```bash
### Authorization: Bearer testç”¨æˆ·ç¼–å·
Authorization: Bearer test1
```

å…¶ä¸­ `"test"` å¯è‡ªå®šä¹‰ï¼Œé…ç½®é¡¹å¦‚ä¸‹ï¼š

```yaml
### application-local.yaml

curleyg:
  security:
    mock-enable: true # æ˜¯å¦å¼€å¯ Token çš„æ¨¡æ‹Ÿæœºåˆ¶
    mock-secret: test # Token æ¨¡æ‹Ÿæœºåˆ¶çš„ Token å‰ç¼€
```

## 3. æƒé™æ³¨è§£

### 3.1 @PreAuthorize æ³¨è§£

[`@PreAuthorize` ]æ˜¯ Spring Security å†…ç½®çš„**å‰ç½®**æƒé™æ³¨è§£ï¼Œæ·»åŠ åœ¨**æ¥å£æ–¹æ³•**ä¸Šï¼Œå£°æ˜éœ€è¦çš„æƒé™ï¼Œå®ç°è®¿é—®æƒé™çš„æ§åˆ¶ã€‚

â‘  åŸºäºã€æƒé™æ ‡è¯†ã€‘çš„æƒé™æ§åˆ¶

æƒé™æ ‡è¯†ï¼Œå¯¹åº” `system_menu` è¡¨çš„ `permission` å­—æ®µï¼Œæ¨èæ ¼å¼ä¸º `${ç³»ç»Ÿ}:${æ¨¡å—}:${æ“ä½œ}`ï¼Œä¾‹å¦‚è¯´ `system:admin:add` æ ‡è¯† system æœåŠ¡çš„æ·»åŠ ç®¡ç†å‘˜ã€‚

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
// ç¬¦åˆ system:user:list æƒé™è¦æ±‚
@PreAuthorize("@ss.hasPermission('system:user:list')")

// ç¬¦åˆ system:user:add æˆ– system:user:edit æƒé™è¦æ±‚å³å¯
@PreAuthorize("@ss.hasAnyPermissions('system:user:add,system:user:edit')")
```

â‘¡ åŸºäºã€è§’è‰²æ ‡è¯†ã€‘çš„æƒé™æ§åˆ¶

æƒé™æ ‡è¯†ï¼Œå¯¹åº” `system_role` è¡¨çš„ `code` å­—æ®µï¼Œ ä¾‹å¦‚è¯´ `super_admin` è¶…çº§ç®¡ç†å‘˜ã€`tenant_admin` ç§Ÿæˆ·ç®¡ç†å‘˜ã€‚

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
// å±äº user è§’è‰²
@PreAuthorize("@ss.hasRole('user')")

// å±äº user æˆ–è€… admin ä¹‹ä¸€
@PreAuthorize("@ss.hasAnyRoles('user', 'admin')")
```

### 3.2å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

å½“ `@PreAuthorize` æ³¨è§£é‡Œçš„ Spring EL è¡¨è¾¾å¼è¿”å› `false` æ—¶ï¼Œè¡¨ç¤ºæ²¡æœ‰æƒé™ã€‚

è€Œ `@PreAuthorize("@ss.hasPermission('system:user:list')")` è¡¨ç¤ºè°ƒç”¨ Bean åå­—ä¸º `ss` çš„ `#hasPermission(...)` æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°ä¸º `"system:user:list"` å­—ç¬¦ä¸²ã€‚`ss` å¯¹åº”çš„ Bean æ˜¯ [PermissionServiceImpl ]ç±»ï¼Œ

1.æ³¨å…¥ä¸€ä¸ªåä¸ºssçš„SecurityFrameworkServiceçš„Bean,ä¸»è¦ç”¨äºé‰´æƒã€‚

```java
   @Bean("ss") // ä½¿ç”¨ Spring Security çš„ç¼©å†™ï¼Œæ–¹ä¾¿ä½¿ç”¨
    public SecurityFrameworkService securityFrameworkService(PermissionApi permissionApi) {
        return new SecurityFrameworkServiceImpl(permissionApi);
    }

```

2.é‰´æƒæ¥å£SecurityFrameworkService

```java
public interface SecurityFrameworkService {

    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æƒé™
     *
     * @param permission æƒé™
     * @return æ˜¯å¦
     */
    boolean hasPermission(String permission);

    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æƒé™ï¼Œä»»ä¸€ä¸€ä¸ªå³å¯
     *
     * @param permissions æƒé™
     * @return æ˜¯å¦
     */
    boolean hasAnyPermissions(String... permissions);

    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰è§’è‰²
     *
     * æ³¨æ„ï¼Œè§’è‰²ä½¿ç”¨çš„æ˜¯ SysRoleDO çš„ code æ ‡è¯†
     *
     * @param role è§’è‰²
     * @return æ˜¯å¦
     */
    boolean hasRole(String role);

    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰è§’è‰²ï¼Œä»»ä¸€ä¸€ä¸ªå³å¯
     *
     * @param roles è§’è‰²æ•°ç»„
     * @return æ˜¯å¦
     */
    boolean hasAnyRoles(String... roles);

    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æˆæƒ
     *
     * @param scope æˆæƒ
     * @return æ˜¯å¦
     */
    boolean hasScope(String scope);

    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æˆæƒèŒƒå›´ï¼Œä»»ä¸€ä¸€ä¸ªå³å¯
     *
     * @param scope æˆæƒèŒƒå›´æ•°ç»„
     * @return æ˜¯å¦
     */
    boolean hasAnyScopes(String... scope);
}

```

3.å®ç°ç±»SecurityFrameworkServiceImpl

åˆ¤æ–­æ˜¯å¦å­˜åœ¨æƒé™ï¼š

ä¸»è¦æµç¨‹å°±æ˜¯æ ¹æ®å½“å‰ç™»å½•ç”¨æˆ·çš„userId,è·å–å½“å‰ç”¨æˆ·çš„è§’è‰²ï¼Œé€šè¿‡è§’è‰²ç»‘å®šçš„èœå•idé›†åˆï¼Œä¸æƒé™æ ‡è¯†ç»‘å®šçš„èœå•idé›†åˆæ¯”è¾ƒã€‚å¦‚æœå­˜åœ¨äº¤é›†è¯´æ˜å­˜åœ¨è¿™ä¸ªæƒé™ã€‚

åˆ¤æ–­æ˜¯å¦å­˜åœ¨è§’è‰²ï¼šé€šè¿‡è·å–å½“å‰ç”¨æˆ·è§’è‰²åˆ—è¡¨çš„code æ ‡è¯†é›†åˆï¼Œåˆ¤æ–­æ˜¯å¦åŒ…å«æŸä¸ªè§’è‰²codeè¿›è¡Œåˆ¤æ–­

ä¸‹é¢ä¸¤ä¸ªæƒé™çš„åˆ¤æ–­æ¶‰åŠåˆ°OAuth2.0å…¶ä»–åº”ç”¨ï¼Œåœ¨åˆ›å»ºtokençš„æ—¶é—´ï¼Œä¼šå°†åº”è¯¥æ‰€èµ‹äºˆçš„æƒé™è®¾ç½®åˆ°LoginUserä¿¡æ¯å½“ä¸­ã€‚ä»¥æ­¤æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨å…¶ä»–æƒé™

```java
    boolean hasScope(String scope);

    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æˆæƒèŒƒå›´ï¼Œä»»ä¸€ä¸€ä¸ªå³å¯
     *
     * @param scope æˆæƒèŒƒå›´æ•°ç»„
     * @return æ˜¯å¦
     */
    boolean hasAnyScopes(String... scope);
```



æ³¨æ„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªæœ‰ç®¡ç†åå°çš„æ¥å£æ‰ä¼šä½¿ç”¨ `@PreAuthorize` æ³¨è§£ï¼Œç”¨æˆ· App çš„æ¥å£ä¸ä¼šä½¿ç”¨ã€‚

## 4. è‡ªå®šä¹‰æƒé™é…ç½®

é»˜è®¤é…ç½®ä¸‹ï¼Œæ‰€æœ‰æ¥å£éƒ½éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®ï¼Œä¸é™äºç®¡ç†åå°çš„ `/admin-api/**` æ‰€æœ‰ API æ¥å£ã€ç”¨æˆ· App çš„ `/app-api/**` æ‰€æœ‰ API æ¥å£ã€‚

å¦‚ä¸‹æƒ³è¦è‡ªå®šä¹‰æƒé™é…ç½®ï¼Œè®¾ç½®å®šä¹‰ API æ¥å£å¯ä»¥åŒ¿åï¼ˆä¸ç™»å½•ï¼‰è¿›è¡Œè®¿é—®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹å¼ï¼š

### 4.1 æ–¹å¼ä¸€ï¼šè‡ªå®šä¹‰ AuthorizeRequestsCustomizer å®ç°

æ¯ä¸ª Maven Module å¯ä»¥å®ç°è‡ªå®šä¹‰çš„ [AuthorizeRequestsCustomizer ]Beanï¼Œé¢å¤–å®šä¹‰æ¯ä¸ª Module çš„ API æ¥å£çš„è®¿é—®è§„åˆ™ã€‚ä¾‹å¦‚è¯´ `curleyg-module-infra` æ¨¡å—çš„ [SecurityConfiguration ]ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Configuration(proxyBeanMethods = false, value = "infraSecurityConfiguration")
public class SecurityConfiguration {

    @Value("${spring.boot.admin.context-path:''}")
    private String adminSeverContextPath;

    @Bean("infraAuthorizeRequestsCustomizer")
    public AuthorizeRequestsCustomizer authorizeRequestsCustomizer() {
        return new AuthorizeRequestsCustomizer() {

            @Override
            public void customize(AuthorizeHttpRequestsConfigurer<HttpSecurity>.AuthorizationManagerRequestMatcherRegistry registry) {
                // Swagger æ¥å£æ–‡æ¡£
                registry.requestMatchers("/v3/api-docs/**").permitAll()
                        .requestMatchers("/swagger-ui.html").permitAll()
                        .requestMatchers("/swagger-ui/**").permitAll()
                        .requestMatchers("/swagger-resources/**").permitAll()
                        .requestMatchers("/webjars/**").permitAll()
                        .requestMatchers("/*/api-docs").permitAll();
                // Spring Boot Actuator çš„å®‰å…¨é…ç½®
                registry.requestMatchers("/actuator").permitAll()
                        .requestMatchers("/actuator/**").permitAll();
                // Druid ç›‘æ§
                registry.requestMatchers("/druid/**").permitAll();
                // Spring Boot Admin Server çš„å®‰å…¨é…ç½®
                registry.requestMatchers(adminSeverContextPath).permitAll()
                        .requestMatchers(adminSeverContextPath + "/**").permitAll();
                // æ–‡ä»¶è¯»å–
                registry.requestMatchers(buildAdminApi("/infra/file/*/get/**")).permitAll();
            }

        };
    }

}
```

å‹æƒ…æç¤º

- `permitAll()` æ–¹æ³•ï¼šæ‰€æœ‰ç”¨æˆ·å¯ä»¥ä»»æ„è®¿é—®ï¼ŒåŒ…æ‹¬å¸¦ä¸Š Token è®¿é—®
- `anonymous()` æ–¹æ³•ï¼šåŒ¿åç”¨æˆ·å¯ä»¥ä»»æ„è®¿é—®ï¼Œå¸¦ä¸Š Token è®¿é—®ä¼šæŠ¥é”™

### 4.2 æ–¹å¼äºŒï¼š

### `@PermitAll` æ³¨è§£

åœ¨ API æ¥å£ä¸Šæ·»åŠ  [`@PermitAll` ]æ³¨è§£ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```java
// FileController.java
@GetMapping("/{configId}/get/{path}")
@PermitAll
public void getFileContent(HttpServletResponse response,
                           @PathVariable("configId") Long configId,
                           @PathVariable("path") String path) throws Exception {
    // ...
}
```

### 4.3 æ–¹å¼ä¸‰ï¼š

### `curleyg.security.permit-all-urls` é…ç½®é¡¹

åœ¨ `application.yaml` é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡ `curleyg.security.permit-all-urls` é…ç½®é¡¹è®¾ç½®ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
curleyg:
  security:
    permit-all-urls:
      - /admin-ui/** # /resources/admin-ui ç›®å½•ä¸‹çš„é™æ€èµ„æº
      - /admin-api/xxx/yyy
```